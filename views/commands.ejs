<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom Commands - Discord Logger</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">
            <h2>ü§ñ <%= client.user.tag %></h2>
        </div>
        <div class="nav-links">
            <a href="/">Dashboard</a>
            <a href="/messages">Messages</a>
            <a href="/deleted">Deleted</a>
            <a href="/members">Members</a>
            <a href="/moderation">Moderation</a>
            <a href="/attachments">Attachments</a>
            <a href="/voice">Voice</a>
            <a href="/invites">Invites</a>
            <a href="/commands" class="active">Commands</a>
            <a href="/analytics">Analytics</a>
            <a href="/logout" class="logout">Logout</a>
        </div>
    </nav>
    
    <div class="container-fluid">
        <div class="commands-header">
            <h1>‚öôÔ∏è Custom Commands</h1>
            <button onclick="toggleCreateForm()" class="btn btn-primary btn-large">
                + Create New Command
            </button>
        </div>

        <!-- Quick Execute Command -->
        <div class="command-section" style="margin-bottom: 2rem;">
            <div class="section-header">
                <h2>‚ö° Quick Execute</h2>
            </div>
            <div class="section-content">
                <form onsubmit="executeCommand(event)" class="executor-form">
                    <select id="channelSelect" required>
                        <option value="">Select Channel...</option>
                    </select>
                    <input type="text" id="commandInput" placeholder="Enter command..." required>
                    <button type="submit" class="btn">Execute</button>
                </form>
                <div id="executeResult"></div>
            </div>
        </div>

        <!-- Create Command Form -->
        <div class="command-section collapsed" id="createCommandSection">
            <div class="section-header" onclick="toggleSection(this)">
                <h2><span class="toggle-icon">‚ñ∂</span> Create New Command</h2>
            </div>
            <div class="section-content" style="display: none;">
                <form method="POST" action="/commands/create">
                    <div class="form-grid">
                        <!-- Left Column -->
                        <div class="form-column">
                            <!-- Basic Info -->
                            <div class="form-card">
                                <h3>üìù Basic Information</h3>
                                <div class="form-group">
                                    <label>Command Name *</label>
                                    <input type="text" name="name" placeholder="My Command" required>
                                </div>
                                
                                <div class="form-group">
                                    <label>Category</label>
                                    <select name="category">
                                        <option value="general">General</option>
                                        <option value="fun">Fun</option>
                                        <option value="moderation">Moderation</option>
                                        <option value="info">Info</option>
                                        <option value="utility">Utility</option>
                                        <option value="custom">Custom</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>Description</label>
                                    <textarea name="description" rows="2" placeholder="What does this command do?"></textarea>
                                </div>
                            </div>

                            <!-- Trigger Settings -->
                            <div class="form-card">
                                <h3>üéØ Trigger Settings</h3>
                                <div class="form-group">
                                    <label>Trigger Type</label>
                                    <select name="triggerType" id="triggerType" onchange="updateTriggerHelp()">
                                        <option value="command">Command (!hello)</option>
                                        <option value="exact">Exact Match</option>
                                        <option value="contains">Contains Text</option>
                                        <option value="startswith">Starts With</option>
                                        <option value="regex">Regex Pattern</option>
                                    </select>
                                    <small id="triggerHelp">Don't include the prefix. Separate multiple with commas: hello, hi, hey</small>
                                </div>
                                
                                <div class="form-group">
                                    <label>Trigger Text *</label>
                                    <input type="text" name="trigger" id="triggerInput" placeholder="hello, hi, hey" required>
                                </div>
                                
                                <div class="form-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="caseSensitive">
                                        <span>Case Sensitive</span>
                                    </label>
                                </div>
                                
                                <div class="form-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="deleteTrigger">
                                        <span>Delete Trigger Message</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Channel Restrictions -->
                            <div class="form-card">
                                <h3>üì∫ Channel Restrictions</h3>
                                <div class="form-group">
                                    <label>Allowed Channels</label>
                                    <input type="text" id="allowedChannelsSearch" placeholder="Search channels..." onkeyup="filterChannels('allowedChannels')">
                                    <div class="channel-selector">
                                        <div class="channel-list" id="allowedChannelsList">
                                            <label class="channel-item">
                                                <input type="checkbox" name="allowedChannels" value="all" checked onchange="handleAllChannels('allowedChannels')">
                                                <span><strong>All Channels</strong></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label>Ignored Channels</label>
                                    <input type="text" id="ignoredChannelsSearch" placeholder="Search channels..." onkeyup="filterChannels('ignoredChannels')">
                                    <div class="channel-selector">
                                        <div class="channel-list" id="ignoredChannelsList">
                                            <!-- Populated by JS -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column -->
                        <div class="form-column">
                            <!-- Response Settings -->
                            <div class="form-card">
                                <h3>üí¨ Response Settings</h3>
                                <div class="form-group">
                                    <label>Response Type</label>
                                    <select name="responseType" id="responseType" onchange="updateResponseType()">
                                        <option value="text">Text Message</option>
                                        <option value="embed">Embed</option>
                                        <option value="react">Reaction Only</option>
                                        <option value="dm">Direct Message</option>
                                        <option value="multiple">Text + Reaction</option>
                                    </select>
                                </div>
                                
                                <!-- Text Response -->
                                <div id="textResponse" class="response-type-content">
                                    <div class="form-group">
                                        <label>Message Content</label>
                                        <textarea name="response" rows="4" placeholder="Hello {user}! Welcome to {server}"></textarea>
                                        <div class="variables-help">
                                            <strong>Available Variables:</strong>
                                            <code>{user}</code> <code>{user.mention}</code> <code>{user.id}</code>
                                            <code>{channel}</code> <code>{server}</code> <code>{membercount}</code>
                                            <code>{args}</code> <code>{args.0}</code> <code>{args.1}</code>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Embed Response -->
                                <div id="embedResponse" class="response-type-content" style="display: none;">
                                    <div class="form-group">
                                        <label>Embed Title</label>
                                        <input type="text" name="embedTitle" placeholder="Welcome!">
                                    </div>
                                    <div class="form-group">
                                        <label>Embed Description</label>
                                        <textarea name="embedDescription" rows="4" placeholder="Welcome to {server}, {user}!"></textarea>
                                    </div>
                                    <div class="form-group-row">
                                        <div class="form-group">
                                            <label>Color</label>
                                            <input type="color" name="embedColor" value="#5865f2">
                                        </div>
                                        <div class="form-group">
                                            <label>Footer Text</label>
                                            <input type="text" name="embedFooter" placeholder="Server Rules">
                                        </div>
                                    </div>
                                    <div class="form-group-row">
                                        <div class="form-group">
                                            <label>Image URL</label>
                                            <input type="text" name="embedImage" placeholder="https://...">
                                        </div>
                                        <div class="form-group">
                                            <label>Thumbnail URL</label>
                                            <input type="text" name="embedThumbnail" placeholder="https://...">
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Reaction Response -->
                                <div id="reactionResponse" class="response-type-content" style="display: none;">
                                    <div class="form-group">
                                        <label>Reaction Emoji</label>
                                        <input type="text" name="reactionEmoji" placeholder="üëç or :custom_emoji:">
                                        <small>Use Unicode emoji (üëç) or custom emoji ID (:custom_emoji:)</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Role Restrictions -->
                            <div class="form-card">
                                <h3>üë§ Role Restrictions</h3>
                                <div class="form-group">
                                    <label>Required Roles</label>
                                    <input type="text" id="requiredRolesSearch" placeholder="Search roles..." onkeyup="filterChannels('requiredRoles')">
                                    <div class="channel-selector">
                                        <div class="channel-list" id="requiredRolesList">
                                            <label class="channel-item">
                                                <input type="checkbox" name="requiredRoles" value="everyone" checked onchange="handleEveryoneRole('requiredRoles')">
                                                <span><strong>@everyone</strong></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label>Ignored Roles</label>
                                    <input type="text" id="ignoredRolesSearch" placeholder="Search roles..." onkeyup="filterChannels('ignoredRoles')">
                                    <div class="channel-selector">
                                        <div class="channel-list" id="ignoredRolesList">
                                            <!-- Populated by JS -->
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Cooldowns & Limits -->
                            <div class="form-card">
                                <h3>‚è±Ô∏è Cooldowns & Limits</h3>
                                <div class="form-group-row">
                                    <div class="form-group">
                                        <label>User Cooldown (seconds)</label>
                                        <input type="number" name="userCooldown" value="0" min="0">
                                    </div>
                                    <div class="form-group">
                                        <label>Channel Cooldown (seconds)</label>
                                        <input type="number" name="channelCooldown" value="0" min="0">
                                    </div>
                                </div>
                                
                                <div class="form-group-row">
                                    <div class="form-group">
                                        <label>Server Cooldown (seconds)</label>
                                        <input type="number" name="serverCooldown" value="0" min="0">
                                    </div>
                                    <div class="form-group">
                                        <label>Max Uses (0 = unlimited)</label>
                                        <input type="number" name="usageLimit" value="0" min="0">
                                    </div>
                                </div>
                            </div>

                            <!-- Additional Options -->
                            <div class="form-card">
                                <h3>‚öôÔ∏è Additional Options</h3>
                                <div class="form-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="dmResponse">
                                        <span>Send as Direct Message</span>
                                    </label>
                                </div>
                                
                                <div class="form-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="deleteAfter">
                                        <span>Auto-Delete Response</span>
                                    </label>
                                </div>
                                
                                <div class="form-group">
                                    <label>Delete After (seconds)</label>
                                    <input type="number" name="deleteAfterSeconds" value="10" min="1">
                                    <small>Only if auto-delete is enabled</small>
                                </div>
                                
                                <div class="form-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="enabled" checked>
                                        <span>Enabled</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" onclick="toggleCreateForm()" class="btn btn-secondary btn-large">Cancel</button>
                        <button type="submit" class="btn btn-primary btn-large">üíæ Create Command</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Existing Commands -->
        <div class="command-section">
            <div class="section-header">
                <h2>üìã Command List</h2>
            </div>
            <div class="section-content">
                <div class="command-filters">
                    <button class="filter-btn active" onclick="filterCommands('all')">All</button>
                    <button class="filter-btn" onclick="filterCommands('general')">General</button>
                    <button class="filter-btn" onclick="filterCommands('fun')">Fun</button>
                    <button class="filter-btn" onclick="filterCommands('moderation')">Moderation</button>
                    <button class="filter-btn" onclick="filterCommands('info')">Info</button>
                    <button class="filter-btn" onclick="filterCommands('utility')">Utility</button>
                    <button class="filter-btn" onclick="filterCommands('custom')">Custom</button>
                </div>

                <div class="commands-table">
                    <% if (commands && commands.length > 0) { %>
                        <% commands.forEach(cmd => { %>
                            <div class="command-row <%= cmd.enabled ? '' : 'disabled' %>" data-category="<%= cmd.category || 'general' %>">
                                <div class="command-main">
                                    <div class="command-info">
                                        <div class="command-name-row">
                                            <h3><%= cmd.name %></h3>
                                            <span class="command-badge <%= cmd.category || 'general' %>"><%= cmd.category || 'general' %></span>
                                            <span class="command-status <%= cmd.enabled ? 'enabled' : 'disabled' %>">
                                                <%= cmd.enabled ? 'Enabled' : 'Disabled' %>
                                            </span>
                                        </div>
                                        
                                        <% if (cmd.description) { %>
                                            <p class="command-desc"><%= cmd.description %></p>
                                        <% } %>
                                        
                                        <div class="command-details">
                                            <span class="detail-item">
                                                <strong>Trigger:</strong> 
                                                <%= cmd.triggerType === 'command' ? '!' : '' %><%= Array.isArray(cmd.trigger) ? cmd.trigger.join(', ') : cmd.trigger %>
                                            </span>
                                            <span class="detail-item">
                                                <strong>Type:</strong> <%= cmd.responseType %>
                                            </span>
                                            <span class="detail-item">
                                                <strong>Uses:</strong> <%= cmd.uses || 0 %>
                                            </span>
                                            <% if (cmd.usageLimit > 0) { %>
                                                <span class="detail-item">
                                                    <strong>Limit:</strong> <%= cmd.uses || 0 %>/<%= cmd.usageLimit %>
                                                </span>
                                            <% } %>
                                        </div>
                                    </div>
                                    
                                    <div class="command-actions-row">
                                        <button class="btn-icon toggle" onclick="toggleCommand('<%= cmd._id %>')" title="Toggle Enable/Disable">
                                            <%= cmd.enabled ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è' %>
                                        </button>
                                        <button class="btn-icon delete" onclick="if(confirm('Delete this command?')) { window.location.href='/commands/delete/<%= cmd._id %>' }" title="Delete Command">
                                            üóëÔ∏è
                                        </button>
                                    </div>
                                </div>
                            </div>
                        <% }); %>
                    <% } else { %>
                        <div class="empty-state">
                            <p>No custom commands yet. Create your first one!</p>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>
    </div>

    <script src="/js/commands.js"></script>
</body>
</html>